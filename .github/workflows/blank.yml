name: Diff Jupyter Notebooks and Create GitHub Pages Site

on:
  pull_request:
    types: [opened]

jobs:
  diff:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/setup-node@v2
        with:
          node-version: 16
          
      - uses: actions/checkout@v2

      - name: Install nbconvert
        run: pip install nbconvert

      - name: Diff notebooks
        run: |
          # Get the hash of the head commit of the pull request.
          head_commit=$(git rev-parse HEAD)

          # Get the changed files in the pull request.
          changed_files=$(git diff --name-only $head_commit HEAD --)

          # Diff the changed Jupyter notebooks.
          for file in $changed_files; do
            nbdiff $file $file -o diff.html
          done

  comment:
    runs-on: ubuntu-latest
    needs: diff
    steps:
      - uses: actions/github-script@v2
        with:
          script: |
            const mygithub = require('@actions/github');
            const { pull_request } = mygithub.context;
            const url = `https://${pull_request.head.repo.full_name}.github.io/diff.html`;
            mygithub.issues.comment({
              issue_number: pull_request.number,
              body: `The diff of the Jupyter notebooks can be found here: ${url}`,
            });
          github-token: ${{secrets.GITHUB_TOKEN}}
          debug: false
          user-agent: actions/github-script
          result-encoding: json
